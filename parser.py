import os
import requests
import time
from datetime import datetime
import urllib.parse
import re

# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–∞—Ç)
TOKEN = os.getenv('TG_TOKEN', '7521422533:AAE2UaEpXpH8yh22gM2nAy3iQKg2EqAkYts')
CHAT = os.getenv('TG_CHAT', '819701342')

BOOKS = [
    "–ü—É—Ç—å –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞ –¢–æ—Ä–±–æ—Å–æ–≤",
    "–î–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞ —Ç–∞–ª–∞–Ω—Ç–æ–≤",
    "0,05 –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω–∞ –ü–µ—Ç—Ä –¢–∞–ª–∞–Ω—Ç–æ–≤",
    "Ritz Carlton –®—É–ª—å—Ü–µ –•–æ—Ä—Å—Ç",
    "–°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ì–∞—Ä–æ–ª—å–¥ –∫–µ—Ä—Ü–Ω–µ—Ä",
    "–ë–ª–∞–≥–æ–≤–æ–ª–∏—Ç–µ–ª—å–Ω–∏—Ü—ã –ª–∏—Ç—Ç–µ–ª–ª",
    "–°–∏–Ω–¥—Ä–æ–º –ü–∞–≥–∞–Ω–∏–Ω–∏",
    "–ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ —É—á–∏—Ç–µ–ª—è –ª–µ–º–æ–≤",
    "–ú–∞—Å—à—Ç–∞–± –î–∂–µ—Ñ—Ñ—Ä–∏ –£—ç—Å—Ç",
    "–ß–µ–ª–æ–≤–µ–∫ –Ω–∞ –≤—Å–µ —Ä—ã–Ω–∫–∏ —Ç–æ—Ä–ø",
    "–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≥–µ–Ω–∏–µ–≤ –î–∏–ª—Ç—Å",
    "–î–Ω–µ–≤–Ω–∏–∫ —Ä–µ–∞–ª–∏—Å—Ç–∞ –í–æ–ª–æ—á–∫–æ–≤",
    "–ü–µ—Ä–≤—ã–µ 20 —á–∞—Å–æ–≤ –ö–∞—É—Ñ–º–∞–Ω",
    "–ü—Ä–∏–Ω—Ü–∏–ø –ê–±—Ä–∞–º–æ–≤–∏—á–∞ –î–æ—Ä–æ—Ñ–µ–µ–≤",
    "–£–∫—Ä–æ—â–µ–Ω–∏–µ –∞–º–∏–≥–¥–∞–ª—ã",
    "–ü—è—Ç–∞—è –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –°–µ–Ω–≥–µ",
    "–°–ª–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è —Ö–æ—Ä–æ–≤–∏—Ü",
    "–ö–∞–∫ –ª—é–¥–∏ —É—á–∞—Ç—Å—è –®–µ–∫–ª—Ç–æ–Ω",
    "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –°–±–µ—Ä–±–∞–Ω–∫–∞",
    "–Ω–∞–∫–∞–∑–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥–æ–π –ê–ª—å—Ñ–∏ –ö–æ–Ω",
    "–∏–Ω–Ω–æ–≤–∞—Ç–æ—Ä—ã –ê–π–∑–µ–∫—Å–æ–Ω –£–æ–ª—Ç–µ—Ä",
    "–ü–∞—Ä–∞–¥–æ–∫—Å –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç–∞",
    "–ú–æ—Ç–∏–≤–∞—Ü–∏—è –¥–ª—è —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –ª—é–¥–µ–π –ú–∞–∫–≥–∏–Ω–Ω–µ—Å—Å",
    "–∫–∞–∫ —Ä–æ–∂–¥–∞—é—Ç—Å—è —ç–º–æ—Ü–∏–∏ –ª–∏–∑–∞ –±–∞—Ä—Ä–µ—Ç—Ç",
    "–≤–∑–ª–æ–º –∫—Ä–µ–∞—Ç–∏–≤–∞ –ú–∞–π–∫–ª –ú–∏–∫–∞–ª–∫–æ",
    "–∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–∏—Å–æ–≤—ã–π —à—Ç—É—Ä–º –ú–∞–π–∫–ª –ú–∏–∫–∞–ª–∫–æ",
    "–í –ø–æ–∏—Å–∫–∞—Ö –ø–∞–º—è—Ç–∏ –∫–∞–Ω–¥–µ–ª—å",
    "–†–∞—Å—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø—Å–∏—Ö–∏–∫–∞ –∫–∞–Ω–¥–µ–ª—å",
    "–∫–∏—Å–ª–æ—Ä–æ–¥ –ù–∏–∫ –õ—ç–π–Ω",
    "–∫–æ–¥ –ü–µ—Ç—Ü–æ–ª—å–¥ –ß–∞—Ä–ª—å–∑",
    "–ø–æ—á–µ–º—É —è –æ—Ç–≤–ª–µ–∫–∞—é—Å—å –≠–¥–≤–∞—Ä–¥ –•—ç–ª–ª–æ–≤—ç–ª–ª",
    "–ø—Ä–∏–Ω—Ü–∏–ø —Å—Ç–∞–≤–æ–∫ —ç–Ω–Ω–∏ –¥—å—é–∫",
    "—Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø–ª–∞—Ç–∏ —Å–µ–±–µ –ú–∏–∫–∞–ª–æ–≤–∏—Ü",
    "—ç–ª–µ–≥–∏—è —Ö–∏–ª–ª–±–∏–ª–ª–∏ –î–∂–µ–π –î–∏ –í—ç–Ω—Å",
    "—Å–ø–∏–Ω –ø—Ä–æ–¥–∞–∂–∏ –Ω–∏–ª —Ä–µ–∫—Ö—ç–º",
    "–ù–µ–ø—Ä–∏—è—Ç–∏–µ –ø–µ—Ä–µ–º–µ–Ω –ö–∏–≥–∞–Ω",
    "–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø–∏—Ç–µ—Ä –¥—Ä—É–∫–µ—Ä",
    "–í—Ä–µ–º—è –ë–µ—Ä–µ–∑–æ–≤—Å–∫–æ–≥–æ –∞–≤–µ–Ω",
    "–ë–∏–æ—Ö–∞–∫–∏–Ω–≥ –û–ª–ª–∏ –°–æ–≤–∏—è—Ä–≤–∏",
    "–ü–∞–º—è—Ç—å –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç –Ω–∞–≤–∞—Ä—Ä–æ",
    "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ —à–∞—Ä–ø",
    "–û –®—Ä–∏—Ñ—Ç–µ —ç—Ä–∏–∫ –®–ø–∏–∫–µ—Ä–º–∞–Ω–Ω",
    "–º–∞—Å—Ç–µ—Ä –∏—Å—Ç–æ—Ä–∏–π –ü–æ–ª –°–º–∏—Ç",
    "—Ä–æ–º–∞ –µ–¥–µ—Ç —Ä–æ–º–∞–Ω –°–≤–µ—á–Ω–∏–∫–æ–≤",
    "—Ç–∏—à–∏–Ω–∞ —Ç–∏—Ç –Ω–∞—Ç —Ö–∞–Ω",
    "–±–µ—Å—Å—Ç—Ä–∞—à–∏–µ —Ç–∏—Ç –Ω–∞—Ç —Ö–∞–Ω",
    "lift –ò–≥–æ—Ä—å –ö–∞–ª–∏–Ω–∞—É—Å–∫–∞—Å",
    "–≤ –ø–æ—Å—Ç–µ–ª–∏ —Å –≤—Ä–∞–≥–æ–º –•—ç–ª –í–æ–Ω",
    "–≥–ª–∞–≤–Ω–∞—è –∫–Ω–∏–≥–∞ –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—è –±–∏–∑–Ω–µ—Å–∞ –í–∞—Å—Å–µ—Ä–º–∞–Ω",
    "–≥–ª–∞–∑–∞–º–∏ —Ñ–∏–∑–∏–∫–∞ –ª–µ–≤–∏–Ω —É–æ–ª—Ç–µ—Ä",
    "–≥–æ–¥ –±–µ–∑ –ø–æ–∫—É–ø–æ–∫ –∫–µ–π—Ç —Ñ–ª–∞–Ω–¥–µ—Ä—Å",
    "–µ—à—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –±–µ–≥–∏ –±—ã—Å—Ç—Ä–æ –°–∫–æ—Ç—Ç –î–∂—É—Ä–µ–∫",
    "–∫–∞–∫ —ç—Ç–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –ú–∞–∫–æ–ª–∏",
    "–∏—Å–∫—É—Å—Å—Ç–≤–æ —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥–∞ –ö–∞—Ä–º–∏–Ω –ì–∞–ª–ª–æ",
    "–º–∞—Å—Ç–µ—Ä —Å–ª–æ–≤–∞ –ö–∞—Ä–º–∏–Ω –ì–∞–ª–ª–æ",
    "–®–ø–∏–æ–Ω –Ω–∞ –º–∏–ª–ª–∏–∞—Ä–¥ –¥–æ–ª–ª–∞—Ä–æ–≤",
    "–∫–æ–¥ –¥—É—Ä–æ–≤–∞",
    "–ª—é–¥–∏ —Å—Ä–µ–¥–∏ –¥–µ—Ä–µ–≤—å–µ–≤",
    "–º–µ–Ω—è—é –∂–∏—Ä –Ω–∞ —Å–∏–ª—É –≤–æ–ª–∏ —è—Ä–æ—Å–ª–∞–≤ –±—Ä–∏–Ω",
    "–º—è—Å–æ —Å –∫—Ä–æ–≤—å—é —ç–Ω—Ç–æ–Ω–∏ –±—É—Ä–¥–µ–Ω",
    "–Ω–∞ –æ–¥–Ω–æ–π –≤–æ–ª–Ω–µ –≠–º–∏ –ë—ç–Ω–∫—Å",
    "–æ–≥–∏–ª–≤–∏ –æ —Ä–µ–∫–ª–∞–º–µ –î—ç–≤–∏–¥ –û–≥–∏–ª–≤–∏",
    "–º–æ—è –∂–∏–∑–Ω—å –≤ —Ä–µ–∫–ª–∞–º–µ –•–æ–ø–∫–∏–Ω—Å",
    "–æ—à–∏–±–∫–∏ –Ω–∞ –º–∏–ª–ª–∏–æ–Ω –¥–æ–ª–ª–∞—Ä–æ–≤",
    "–ø–∞—Ä–∞–¥–æ–∫—Å –ø–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç–∞ –¢–∞–ª –ë–µ–Ω-–®–∞—Ö–∞—Ä",
    "—Å–ª–æ–Ω –Ω–∞ —Ç–∞–Ω—Ü–ø–æ–ª–µ",
    "—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å –õ–æ—Ä–µ–π–Ω –ì—Ä–∞–±—Å-–£—ç—Å—Ç",
    "—É–ª—å—Ç—Ä–∞–º—ã—à–ª–µ–Ω–∏–µ —Ö—ç–Ω–∫ –¥–∂–æ–Ω",
    "–ø–µ—Ä–≤—ã–µ 90 –¥–Ω–µ–π –º–∞–π–∫–ª —É–æ—Ç–∫–∏–Ω—Å",
    "18 –º–∏–Ω—É—Ç –±—Ä–µ–≥–º–∞–Ω",
    "–°–æ –º–Ω–æ–π —Ö–æ—Ç—è—Ç –æ–±—â–∞—Ç—å—Å—è –∑–≤–µ—Ä–µ–≤–∞",
    "–†–∞–¥–æ—Å—Ç—å –∏–∑–Ω—É—Ç—Ä–∏ —Ç–∞–Ω"
]
def send_telegram(text):
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram"""
    url = f'https://api.telegram.org/bot{TOKEN}/sendMessage'
    try:
        r = requests.post(url, json={
            'chat_id': CHAT,
            'text': text,
            'parse_mode': 'HTML'
        }, timeout=5)
        return r.status_code == 200
    except:
        return False

def search_avito_today(book):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.
    –†–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –¥–∞—Ç–∞–º–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä cd=1 –ê–≤–∏—Ç–æ.
    """
    query = urllib.parse.quote(book)
    
    # –ú–ê–ì–ò–Ø: cd=1 = "–∑–∞ —Å—É—Ç–∫–∏" - –ê–≤–∏—Ç–æ —Å–∞–º —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ
    url = f"https://www.avito.ru/rossiya/knigi_i_zhurnaly?cd=1&q={query}&s=104"
    
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',
    }
    
    try:
        response = requests.get(url, headers=headers, timeout=10)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–ø—á—É –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        if '–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω' in response.text or 'captcha' in response.text.lower():
            print(f"‚ö†Ô∏è  –ê–≤–∏—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–∏–ª –¥–æ—Å—Ç—É–ø –¥–ª—è: {book}")
            return False, None, None
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        if '–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π' in response.text:
            return False, None, None
        
        # –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ü–ê–†–°–ò–ù–ì (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–π –¥–∞—Ç–æ–π)
        # –ò—â–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        page = response.text
        
        # –í–∞—Ä–∏–∞–Ω—Ç 1: –Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ê–≤–∏—Ç–æ
        link_match = re.search(r'itemprop="url"[^>]*content="(https://www\.avito\.ru[^"]+)"', page)
        date_match = re.search(r'data-marker="item-date">([^<]+)<', page)
        
        # –í–∞—Ä–∏–∞–Ω—Ç 2: —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Ä–µ–∑–µ—Ä–≤)
        if not link_match:
            link_match = re.search(r'href="(https://www\.avito\.ru/[^"]+/\d+)"', page)
        if not date_match:
            date_match = re.search(r'class="[^"]*date[^"]*"[^>]*>([^<]+)<', page)
        
        if link_match and date_match:
            item_url = link_match.group(1)
            pub_date = date_match.group(1).strip()
            
            # –í–ê–ñ–ù–û: –ê–≤–∏—Ç–æ —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç "—Å–µ–≥–æ–¥–Ω—è"
            # "—Å–µ–≥–æ–¥–Ω—è" = –≤—Å–µ–≥–¥–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            if '—Å–µ–≥–æ–¥–Ω—è' in pub_date.lower():
                return True, item_url, pub_date
        
        return False, None, None
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ {book}: {e}")
        return False, None, None

def main():
     """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ —Å –∞–≤—Ç–æ-—Ç–µ—Å—Ç–æ–º —Ä–∞–±–æ—Ç—ã"""
    
    # === –ê–í–¢–û-–¢–ï–°–¢ –ü–†–ò –ö–ê–ñ–î–û–ú –ó–ê–ü–£–°–ö–ï ===
    print("=" * 60)
    print(f"ü§ñ –ê–í–¢–û-–¢–ï–°–¢ –†–ê–ë–û–¢–´ –ü–ê–†–°–ï–†–ê")
    print(f"üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%d.%m.%Y')}")
    print(f"‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M:%S')}")
    print("=" * 60)
    
    # –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram
    test_message = (
        f"üîÑ <b>–ü–∞—Ä—Å–µ—Ä –∑–∞–ø—É—â–µ–Ω</b>\n"
        f"üìÖ {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n"
        f"üìö –ü—Ä–æ–≤–µ—Ä—è—é {len(BOOKS)} –∫–Ω–∏–≥\n"
        f"üîç –ò—â—É: —Ç–æ–ª—å–∫–æ –°–ï–ì–û–î–ù–Ø–®–ù–ò–ï –æ–±—ä—è–≤–ª–µ–Ω–∏—è"
    )
    
    telegram_ok = send_telegram(test_message, silent=True)
    
    if telegram_ok:
        print("‚úÖ Telegram: –û–ö (—Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ)")
    else:
        print("‚ùå Telegram: –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏")
    
    # –î–∞–ª—å—à–µ –∏–¥–µ—Ç –æ–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–∏–≥...
    run_parser()

    """–í–µ—á–Ω—ã–π –ø–∞—Ä—Å–µ—Ä (—Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±—ã–º–∏ –¥–∞—Ç–∞–º–∏)"""
    current_datetime = datetime.now()
    date_str = current_datetime.strftime('%d.%m.%Y')
    time_str = current_datetime.strftime('%H:%M:%S')
    
    print(f"\n{'='*70}")
    print(f"üåê –í–ï–ß–ù–´–ô –ü–ê–†–°–ï–† | –î–ê–¢–ê: {date_str} | –í–†–ï–ú–Ø: {time_str}")
    print(f"{'='*70}")
    
    found_count = 0
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∫–Ω–∏–≥
    for i, book in enumerate(BOOKS, 1):
        status = f"[{i:2d}/{len(BOOKS)}] {book[:40]:<40}"
        
        found, url, pub_date = search_avito_today(book)
        
        if found:
            found_count += 1
            print(f"{status} ‚úÖ –°–ï–ì–û–î–ù–Ø ({pub_date})")
            
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–¥–∞—Ç–∞ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            message = (
                f"üÜï <b>–ù–û–í–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï {date_str}!</b>\n\n"
                f"üìñ <b>{book}</b>\n"
                f"üìÖ {pub_date}\n"
                f"üîó <a href='{url}'>–°–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ê–≤–∏—Ç–æ</a>\n"
                f"‚è∞ –ù–∞–π–¥–µ–Ω–æ: {time_str}"
            )
            send_telegram(message)
            time.sleep(0.5)
        else:
            print(f"{status} üì≠ –Ω–µ—Ç –Ω–æ–≤—ã—Ö")
        
        time.sleep(1)
    
    # –ò—Ç–æ–≥
    print(f"{'='*70}")
    print(f"üìä –ò–¢–û–ì {date_str}: {found_count} –Ω–æ–≤—ã—Ö –∏–∑ {len(BOOKS)} –∫–Ω–∏–≥")
    print(f"{'='*70}")
    
    if found_count > 0:
        send_telegram(
            f"üìä <b>–û—Ç—á—ë—Ç {date_str}</b>\n"
            f"‚úÖ –ù–∞–π–¥–µ–Ω–æ: {found_count} –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π\n"
            f"üîÑ –°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç"
        )

if __name__ == "__main__":
    main()
